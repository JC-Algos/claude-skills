#!/usr/bin/env python3
"""
Stock Name Lookup - Get Chinese names for HK stocks via Sina Finance API
"""

import requests
import re
from functools import lru_cache

SINA_API_URL = "https://hq.sinajs.cn/list=hk{code}"

HEADERS = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
    'Referer': 'https://finance.sina.com.cn'
}

# Cache for stock names to avoid repeated API calls
_name_cache = {}


@lru_cache(maxsize=500)
def get_chinese_name(stock_code: str) -> str:
    """
    Get Chinese name for a HK stock code via Sina Finance API.
    Returns the Chinese name or the stock code if not found.
    
    Args:
        stock_code: Stock code (e.g., "0700", "700", "2318")
    
    Returns:
        Chinese name (e.g., "騰訊控股") or stock code if not found
    """
    # Normalize code to 5 digits with leading zeros
    code = str(stock_code).zfill(5)
    
    try:
        url = SINA_API_URL.format(code=code)
        response = requests.get(url, headers=HEADERS, timeout=5)
        
        if response.status_code == 200:
            # Parse response: var hq_str_hk00700="TENCENT,腾讯控股,..."
            match = re.search(r'"([^"]+)"', response.text)
            if match:
                parts = match.group(1).split(',')
                if len(parts) >= 2 and parts[1]:
                    # Convert simplified to traditional Chinese if needed
                    chinese_name = parts[1]
                    return convert_to_traditional(chinese_name)
    except Exception as e:
        pass
    
    return stock_code


def convert_to_traditional(text: str) -> str:
    """
    Convert simplified Chinese to traditional Chinese.
    Uses a simple mapping for common financial terms.
    """
    # Common simplified -> traditional mappings for stock names
    mappings = {
        '腾讯': '騰訊',
        '阿里': '阿里',
        '中国': '中國',
        '小米': '小米',
        '美团': '美團',
        '京东': '京東',
        '网易': '網易',
        '百度': '百度',
        '拼多多': '拼多多',
        '快手': '快手',
        '哔哩哔哩': '嗶哩嗶哩',
        '携程': '攜程',
        '蔚来': '蔚來',
        '理想': '理想',
        '小鹏': '小鵬',
        '比亚迪': '比亞迪',
        '宁德时代': '寧德時代',
        '舜宇': '舜宇',
        '光学': '光學',
        '联想': '聯想',
        '中芯': '中芯',
        '华虹': '華虹',
        '商汤': '商湯',
        '海底捞': '海底撈',
        '安踏': '安踏',
        '李宁': '李寧',
        '周大福': '周大福',
        '老铺': '老鋪',
        '黄金': '黃金',
        '万国': '萬國',
        '金沙': '金沙',
        '银河': '銀河',
        '永利': '永利',
        '新濠': '新濠',
        '金界': '金界',
        '招商': '招商',
        '工商': '工商',
        '建设': '建設',
        '农业': '農業',
        '交通': '交通',
        '邮储': '郵儲',
        '中信': '中信',
        '兴业': '興業',
        '浦发': '浦發',
        '民生': '民生',
        '光大': '光大',
        '华夏': '華夏',
        '平安': '平安',
        '太保': '太保',
        '太平': '太平',
        '新华': '新華',
        '人寿': '人壽',
        '财险': '財險',
        '友邦': '友邦',
        '众安': '眾安',
        '紫金': '紫金',
        '洛阳钼业': '洛陽鉬業',
        '江西铜业': '江西銅業',
        '中国神华': '中國神華',
        '中国石油': '中國石油',
        '中国石化': '中國石化',
        '中国海油': '中國海油',
        '万科': '萬科',
        '融创': '融創',
        '碧桂园': '碧桂園',
        '世茂': '世茂',
        '龙湖': '龍湖',
        '华润': '華潤',
        '中海': '中海',
        '绿城': '綠城',
        '恒大': '恆大',
        '佳兆业': '佳兆業',
        '奥园': '奧園',
        '九龙仓': '九龍倉',
        '新鸿基': '新鴻基',
        '长实': '長實',
        '恒基': '恆基',
        '新世界': '新世界',
        '嘉里': '嘉里',
        '信和': '信和',
        '太古': '太古',
        '九仓': '九倉',
        '港铁': '港鐵',
        '领展': '領展',
        '中电': '中電',
        '港灯': '港燈',
        '电能': '電能',
        '煤气': '煤氣',
        '香港': '香港',
        '中远': '中遠',
        '海运': '海運',
        '东方海外': '東方海外',
        '国泰': '國泰',
        '中银': '中銀',
        '恒生': '恒生',
        '汇丰': '滙豐',
        '渣打': '渣打',
        '东亚': '東亞',
        '玖纸': '玖紙',
        '理文': '理文',
        '晨鸣': '晨鳴',
        '中联重科': '中聯重科',
        '三一': '三一',
        '徐工': '徐工',
        '潍柴': '濰柴',
        '中集': '中集',
        '赣锋': '贛鋒',
        '天齐': '天齊',
        '药明': '藥明',
        '康泰': '康泰',
        '石药': '石藥',
        '翰森': '翰森',
        '信达': '信達',
        '百济': '百濟',
        '荣昌': '榮昌',
        '和黄': '和黃',
        '复星': '復星',
        '君实': '君實',
        '再鼎': '再鼎',
        '亚盛': '亞盛',
        '科济': '科濟',
        '诺诚': '諾誠',
        '加科思': '加科思',
        '海吉亚': '海吉亞',
        '新东方': '新東方',
        '好未来': '好未來',
        '高途': '高途',
        '中公': '中公',
        '有道': '有道',
        '贝壳': '貝殼',
        '华住': '華住',
        '锦江': '錦江',
        '首旅': '首旅',
        '同程': '同程',
        '途牛': '途牛',
        '华侨城': '華僑城',
        '海昌': '海昌',
        '宋城': '宋城',
        '中国中免': '中國中免',
        '海底捞': '海底撈',
        '九毛九': '九毛九',
        '奈雪': '奈雪',
        '海伦司': '海倫司',
        '蜜雪': '蜜雪',
        '瑞幸': '瑞幸',
        '农夫': '農夫',
        '山泉': '山泉',
        '蒙牛': '蒙牛',
        '伊利': '伊利',
        '飞鹤': '飛鶴',
        '维他奶': '維他奶',
        '康师傅': '康師傅',
        '统一': '統一',
        '青岛啤酒': '青島啤酒',
        '华润啤酒': '華潤啤酒',
        '百威': '百威',
        '金龙鱼': '金龍魚',
        '颐海': '頤海',
        '海天': '海天',
        '稀宇': '稀宇',
        '地平线': '地平線',
        '健康': '健康',
        '控股': '控股',
        '集团': '集團',
        '银行': '銀行',
        '保险': '保險',
        '证券': '證券',
        '电子': '電子',
        '科技': '科技',
        '医药': '醫藥',
        '医疗': '醫療',
        '汽车': '汽車',
        '电力': '電力',
        '能源': '能源',
        '石油': '石油',
        '钢铁': '鋼鐵',
        '铜业': '銅業',
        '矿业': '礦業',
        '地产': '地產',
        '发展': '發展',
        '国际': '國際',
        '联通': '聯通',
        '电信': '電信',
        '移动': '移動',
        '网络': '網絡',
        '软件': '軟件',
        '硬件': '硬件',
        '制造': '製造',
        '机械': '機械',
        '设备': '設備',
        '服务': '服務',
        '贸易': '貿易',
        '运输': '運輸',
        '航空': '航空',
        '铁路': '鐵路',
        '港口': '港口',
        '物流': '物流',
        '零售': '零售',
        '百货': '百貨',
        '食品': '食品',
        '饮料': '飲料',
        '农业': '農業',
        '化工': '化工',
        '材料': '材料',
        '建筑': '建築',
        '工程': '工程',
        '环保': '環保',
        '新能源': '新能源',
        '光伏': '光伏',
        '风电': '風電',
        '锂电': '鋰電',
        '电池': '電池',
        '芯片': '芯片',
        '半导体': '半導體',
        '显示': '顯示',
        '面板': '面板',
        '通信': '通信',
        '传媒': '傳媒',
        '娱乐': '娛樂',
        '游戏': '遊戲',
        '教育': '教育',
        '体育': '體育',
        '旅游': '旅遊',
        '酒店': '酒店',
        '餐饮': '餐飲',
        '物业': '物業',
        '管理': '管理',
        '投资': '投資',
        '资本': '資本',
        '金融': '金融',
        '信托': '信託',
        '基金': '基金',
        '期货': '期貨',
        '交易': '交易',
        '结算': '結算',
        '清算': '清算',
        '支付': '支付',
        '数据': '數據',
        '云计算': '雲計算',
        '人工智能': '人工智能',
        '机器人': '機器人',
        '自动化': '自動化',
        '电商': '電商',
        '平台': '平台',
        '生物': '生物',
        '制药': '製藥',
        '创新': '創新',
        '研发': '研發',
        '实验': '實驗',
        '检测': '檢測',
        '诊断': '診斷',
        '治疗': '治療',
        '器械': '器械',
        '设施': '設施',
        '运营': '運營',
        '开发': '開發',
        '建设': '建設',
        '规划': '規劃',
        '设计': '設計',
        '咨询': '諮詢',
        '顾问': '顧問',
        '审计': '審計',
        '会计': '會計',
        '法律': '法律',
        '知识产权': '知識產權',
        '专利': '專利',
        '商标': '商標',
        '品牌': '品牌',
        '营销': '營銷',
        '广告': '廣告',
        '宣传': '宣傳',
        '公关': '公關',
        '策划': '策劃',
        '执行': '執行',
        '监督': '監督',
        '审查': '審查',
        '合规': '合規',
        '风险': '風險',
        '内控': '內控',
        '质量': '質量',
        '标准': '標準',
        '认证': '認證',
        '评估': '評估',
        '评级': '評級',
        '分析': '分析',
        '预测': '預測',
        '报告': '報告',
        '研究': '研究',
        '调查': '調查',
        '统计': '統計',
        '数学': '數學',
        '计算': '計算',
        '算法': '算法',
        '模型': '模型',
        '系统': '系統',
        '应用': '應用',
        '产品': '產品',
        '解决方案': '解決方案',
        '项目': '項目',
        '工厂': '工廠',
        '车间': '車間',
        '仓库': '倉庫',
        '配送': '配送',
        '快递': '快遞',
        '邮政': '郵政',
        '通讯': '通訊',
        '宽带': '寬帶',
        '无线': '無線',
        '卫星': '衛星',
        '导航': '導航',
        '定位': '定位',
        '测量': '測量',
        '仪器': '儀器',
        '仪表': '儀表',
        '传感器': '傳感器',
        '控制器': '控制器',
        '处理器': '處理器',
        '存储': '存儲',
        '内存': '內存',
        '硬盘': '硬盤',
        '固态': '固態',
        '闪存': '閃存',
        '电源': '電源',
        '变压器': '變壓器',
        '开关': '開關',
        '插座': '插座',
        '电缆': '電纜',
        '光纤': '光纖',
        '连接器': '連接器',
        '接口': '接口',
        '协议': '協議',
        '标准化': '標準化',
        '国标': '國標',
        '行标': '行標',
        '团标': '團標',
        '企标': '企標',
    }
    
    result = text
    for simp, trad in mappings.items():
        result = result.replace(simp, trad)
    
    return result


def get_chinese_names_batch(stock_codes: list) -> dict:
    """
    Get Chinese names for multiple stock codes.
    
    Args:
        stock_codes: List of stock codes
    
    Returns:
        Dict mapping stock code to Chinese name
    """
    result = {}
    for code in stock_codes:
        result[code] = get_chinese_name(code)
    return result


if __name__ == "__main__":
    # Test
    test_codes = ['0700', '2318', '9988', '1810', '3690', '0241', '9992']
    for code in test_codes:
        name = get_chinese_name(code)
        print(f"{code}: {name}")
